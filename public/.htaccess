# ==============================================================================
# Sistema de Requisiciones MVC - Apache Configuration
# ==============================================================================
#
# Este archivo configura el rewriting de URLs para dirigir todas las peticiones
# al index.php del sistema MVC, permitiendo URLs amigables sin extensión .php
#
# Ejemplos de transformación:
# /requisiciones/123 -> /index.php?_uri=/requisiciones/123
# /admin/usuarios -> /index.php?_uri=/admin/usuarios
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Habilitar el motor de reescritura
# ------------------------------------------------------------------------------
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # --------------------------------------------------------------------------
    # Establecer el directorio base
    # --------------------------------------------------------------------------
    # Si la aplicación está en un subdirectorio, ajustar RewriteBase
    # Ejemplo: Si está en /requisiciones/public, usar: RewriteBase /requisiciones/public/
    RewriteBase /
    
    # --------------------------------------------------------------------------
    # Proteger archivos y directorios sensibles
    # --------------------------------------------------------------------------
    # Denegar acceso directo a archivos de configuración, logs y sensibles
    RewriteRule ^(\..+|composer\.json|composer\.lock|package\.json)$ - [F,L]
    
    # --------------------------------------------------------------------------
    # Permitir acceso directo a archivos existentes
    # --------------------------------------------------------------------------
    # Si el archivo o directorio existe físicamente, servir directamente
    # Esto permite acceso a CSS, JS, imágenes, etc.
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # --------------------------------------------------------------------------
    # Redirigir todo lo demás a index.php
    # --------------------------------------------------------------------------
    # [QSA] = Query String Append (preservar parámetros GET)
    # [L] = Last (última regla, no procesar más)
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>

# ------------------------------------------------------------------------------
# Deshabilitar listado de directorios
# ------------------------------------------------------------------------------
Options -Indexes

# ------------------------------------------------------------------------------
# Configuración de tipos MIME
# ------------------------------------------------------------------------------
<IfModule mod_mime.c>
    # CSS
    AddType text/css .css
    
    # JavaScript
    AddType application/javascript .js
    AddType application/x-javascript .js
    
    # JSON
    AddType application/json .json
    
    # Imágenes
    AddType image/svg+xml .svg .svgz
    
    # Fuentes
    AddType application/vnd.ms-fontobject .eot
    AddType font/ttf .ttf
    AddType font/otf .otf
    AddType font/woff .woff
    AddType font/woff2 .woff2
</IfModule>

# ------------------------------------------------------------------------------
# Compresión GZIP para mejorar performance
# ------------------------------------------------------------------------------
<IfModule mod_deflate.c>
    # Comprimir HTML, CSS, JavaScript, texto, XML
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/plain
</IfModule>

# ------------------------------------------------------------------------------
# Cache de recursos estáticos
# ------------------------------------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Imágenes - 1 mes
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 month"
    
    # CSS y JavaScript - 1 semana
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType application/x-javascript "access plus 1 week"
    
    # Fuentes - 1 mes
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType font/otf "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    
    # HTML - Sin cache
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ------------------------------------------------------------------------------
# Headers de seguridad
# ------------------------------------------------------------------------------
<IfModule mod_headers.c>
    # Prevenir MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Protección XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevenir clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Política de referrer
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ------------------------------------------------------------------------------
# Configuración de charset UTF-8
# ------------------------------------------------------------------------------
AddDefaultCharset UTF-8
<IfModule mod_mime.c>
    AddCharset UTF-8 .html .css .js .xml .json .txt .php
</IfModule>

# ------------------------------------------------------------------------------
# Protección contra inyección de PHP
# ------------------------------------------------------------------------------
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|bak)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# ------------------------------------------------------------------------------
# Configuración PHP
# ------------------------------------------------------------------------------
<IfModule mod_php7.c>
    # Tamaño máximo de upload (ajustar según necesidades)
    php_value upload_max_filesize 20M
    php_value post_max_size 20M
    
    # Memoria y tiempo de ejecución
    php_value memory_limit 256M
    php_value max_execution_time 300
    
    # Zona horaria
    php_value date.timezone "America/Guatemala"
</IfModule>
